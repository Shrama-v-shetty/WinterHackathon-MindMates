<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MindMates | Counsellor Dashboard</title>
  <link rel="stylesheet" href="dashboard1.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>

<header class="topbar">
  <div class="logo">
    <img src="img3.png" class="brand-icon">
    <span class="brand-name">MindMates</span>
  </div>
  <div class="profile">
    <span>Dr. Sarah Johnson</span>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<main class="container">
  <h1 class="welcome">Welcome, Dr. Johnson</h1>
  <p class="subtitle" id="todayCount">You have 0 appointments today</p>

  <!-- Stats -->
  <section class="stats">
    <div class="card stat"><h3 id="statToday">0</h3><p>Today's Sessions</p></div>
    <div class="card stat"><h3 id="statUpcoming">0</h3><p>Upcoming</p></div>
    <div class="card stat"><h3>24</h3><p>Completed</p></div>
    <div class="card stat"><h3>18</h3><p>Active Patients</p></div>
  </section>

  <div class="grid">

    <!-- LEFT -->
    <div class="column">

      <div class="card today-card">
        <h2>Today's Appointments</h2>
        <div id="todayAppointments"></div>
      </div>

      <div class="card upcoming-card">
        <h2>Upcoming Appointments</h2>
        <div id="upcomingAppointments"></div>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="column">

      <div class="card gradient">
        <h2>üö® Emergency Help</h2>
        <p>Help patients reach emergency care without delay</p>

        <select id="hospitalSelect" class="btn full white">
          <option value="">Select Hospital</option>
          <option value="https://maps.google.com/?q=KMC+Hospital+Mangalore">KMC Hospital</option>
          <option value="https://maps.google.com/?q=Father+Muller+Hospital">Father Muller Hospital</option>
        </select>

        <button class="btn full green" onclick="sendHospital()">Send Hospital Location</button>
      </div>

      <div class="card">
        <h2>Availability Status</h2>
        <div id="availabilityStatus" class="status available">‚óè Available</div>
        <button class="btn full gray" onclick="toggleStatus()">Set as Busy</button>
      </div>

    </div>
  </div>
</main>

<!-- üî• FIREBASE CONFIG -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC8C6ncKCm4cH0yhMZaPHzzS5GfbDZvp84",
  authDomain: "mindmates-286b9.firebaseapp.com",
  projectId: "mindmates-286b9",
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const COUNSELLOR_ID = "COUNSELLOR_001";
</script>

<!-- üî• LOGIC -->
<script>
let isAvailable = true;

function toggleStatus() {
  const status = document.getElementById("availabilityStatus");
  isAvailable = !isAvailable;
  status.textContent = isAvailable ? "‚óè Available" : "‚óè Busy";
  status.className = "status " + (isAvailable ? "available" : "busy");
}

function logout() {
  auth.signOut().then(() => window.location.href = "index.html");
}

function openChat() {
  window.location.href = "chat.html";
}

function sendHospital() {
  const link = document.getElementById("hospitalSelect").value;
  if (!link) return alert("Select a hospital");
  window.open(link, "_blank");
}

/* üî• LOAD APPOINTMENTS */
auth.onAuthStateChanged(user => {
  if (!user) return;
  loadAppointments();
});

function loadAppointments() {
  const todayBox = document.getElementById("todayAppointments");
  const upcomingBox = document.getElementById("upcomingAppointments");

  const today = new Date();
  today.setHours(0,0,0,0);

  let todayCount = 0;
  let upcomingCount = 0;

  db.collection("appointments")
    .where("counsellorId", "==", COUNSELLOR_ID)
    .onSnapshot(snapshot => {
      todayBox.innerHTML = "";
      upcomingBox.innerHTML = "";

      snapshot.forEach(doc => {
        const a = doc.data();

        // SAFELY convert date
        let d;
        if (a.date?.toDate) {
          d = a.date.toDate();
        } else {
          d = new Date(a.date);
        }
        d.setHours(0,0,0,0);

        // Buttons for actions
        const html = `
          <div class="appointment">
            <div>
              <strong>${a.studentName}</strong>
              <span>${a.time}</span>
            </div>
            <div class="actions">
              <button class="btn gray" title="Add Note" onclick="openNote('${doc.id}')">üìù</button>
              <button class="btn purple" title="Chat" onclick="openChat('${doc.id}')">üí¨</button>
              <button class="btn blue" title="Video Call" onclick="startVideo('${doc.id}')">üìπ</button>
            </div>
          </div>
        `;

        // Append to today or upcoming
        if (
          d.getFullYear() === today.getFullYear() &&
          d.getMonth() === today.getMonth() &&
          d.getDate() === today.getDate()
        ) {
          todayBox.innerHTML += html;
          todayCount++;
        } else if (d > today) {
          upcomingBox.innerHTML += html;
          upcomingCount++;
        }
      });

      // Update stats
      document.getElementById("statToday").textContent = todayCount;
      document.getElementById("statUpcoming").textContent = upcomingCount;
      document.getElementById("todayCount").textContent =
        `You have ${todayCount} appointments today`;
    });
}

function acceptAppointment(id) {
  db.collection("appointments").doc(id).update({
    status: "accepted"
  }).then(() => {
    alert("‚úÖ Appointment accepted");
  });
}
function openNote(appointmentId) {
  // Redirect to note.html with appointmentId as query param
  window.location.href = `notes.html?appointmentId=${appointmentId}`;
}

function openChat(appointmentId) {
  // Redirect to chat.html with appointmentId as query param
  window.location.href = "counsellor_chat.html"
}

function startVideo(appointmentId) {
  // Redirect to video call page or integrate SDK
 
    window.open("https://meet.google.com/new", "_blank");
}

</script>

</body>
</html>

